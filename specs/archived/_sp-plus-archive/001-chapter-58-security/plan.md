# Chapter 58: Production Security & Compliance — Implementation Plan

**Generated by**: chapter-planner v2.0.0 (Reasoning-Activated)
**Source Spec**: specs/001-chapter-58-security/spec.md
**Expertise Skill**: .claude/skills/building-with-cloud-security/SKILL.md
**Created**: 2025-12-30
**Constitution**: v6.0.0 (Reasoning Mode)

---

## I. Chapter Analysis

### Chapter Type

**Technical/Code-Focused** — Recognition signals:
- Learning objectives use "apply/create/implement" verbs (RBAC implementation, NetworkPolicy creation, PSS enforcement)
- Code examples required in spec (YAML manifests, kubectl commands)
- Hands-on acceptance scenarios (test with `kubectl auth can-i`, verify blocked traffic)

### Concept Density Analysis

**Core Concepts** (from spec): 12 concepts

1. 4C Security Model (Cloud, Cluster, Container, Code)
2. Defense in Depth Philosophy
3. RBAC (Roles, ClusterRoles, RoleBindings, ServiceAccounts)
4. Least Privilege Principle
5. NetworkPolicy (default deny, allow rules)
6. CNI Requirements (Calico)
7. Pod Security Standards (Privileged, Baseline, Restricted)
8. Pod Security Admission
9. Secrets Management Hierarchy (K8s Secrets, Sealed Secrets, ESO)
10. Image Scanning (Trivy, SBOM, Cosign)
11. Dapr Security (mTLS, API tokens, component scopes)
12. Compliance Awareness (SOC2, HIPAA technical controls)

**Complexity Assessment**: Complex (12 interconnected concepts, requires prior K8s knowledge)

**Proficiency Tier**: B1 (Intermediate) — from spec and chapter-index.md (Part 7 Tier 2: Enterprise)

**Justified Lesson Count**: 10 lessons (L00-L09)

| Layer | Lessons | Justification |
|-------|---------|---------------|
| Layer 3 (Skill) | L00 | Skill-First pattern — create cloud-security skill before learning |
| Layer 1 (Manual) | L01-L06, L08 | 7 manual lessons for 8 core security domains (4C, RBAC, NetworkPolicy, Secrets, PSS, Image Scanning, Compliance) |
| Layer 2 (AI Collab) | L07 | Dapr security with AI collaboration (Three Roles) |
| Layer 4 (Capstone) | L09 | Spec-driven integration with security audit checklist |

**Total**: 10 lessons — matches spec structure, justified by concept density (12 concepts / B1 proficiency = 8 content lessons + L00 skill + L09 capstone)

---

## II. Success Evals (from Spec)

**Predefined Success Criteria** (evals-first requirement):

| ID | Success Criterion | Measurable Target |
|----|-------------------|-------------------|
| SC-001 | Create working `cloud-security` skill | Under 15 minutes (L00) |
| SC-002 | Classify security controls by 4C layer | 90% accuracy on 5+ controls |
| SC-003 | Task API runs with dedicated ServiceAccount | ConfigMap read only (not wildcard) |
| SC-004 | Unauthorized traffic blocked | Verifiable with test pod |
| SC-005 | Task API passes PSS restricted profile | Pod admitted to restricted namespace |
| SC-006 | No CRITICAL vulnerabilities | Trivy reports 0 CRITICAL |
| SC-007 | Complete 10-point security audit | All items passing |
| SC-008 | Articulate 3 K8s controls for SOC2 | Access control requirements |

**All lessons map to these evals.**

---

## III. Pedagogical Arc

```
L00: Build Your Cloud Security Skill (15 min) - Layer 3
  |   +-- Create skill from official docs
  |   +-- Foundation for chapter learning
  |
  +-- PHASE 1: MENTAL MODEL ----------------
  |
  L01: Cloud Native Security Model (25 min) - Layer 1
  |   +-- 4C model: Cloud, Cluster, Container, Code
  |   +-- Defense in depth philosophy
  |   +-- Why outer layers must be secure
  |
  +-- PHASE 2: CORE SECURITY CONTROLS ------
  |
  L02: RBAC Deep Dive (30 min) - Layer 1
  |   +-- ServiceAccounts, Roles, RoleBindings
  |   +-- Least privilege principle
  |   +-- Testing with kubectl auth can-i
  |
  L03: NetworkPolicies (30 min) - Layer 1
  |   +-- Default deny pattern (CRITICAL)
  |   +-- Explicit allow rules (DNS, ingress, egress)
  |   +-- Calico CNI installation
  |
  L04: Secrets Management (25 min) - Layer 1
  |   +-- K8s Secrets creation and consumption
  |   +-- Volume mounts vs environment variables
  |   +-- Sealed Secrets / ESO overview
  |
  L05: Pod Security Standards (25 min) - Layer 1
  |   +-- PSS levels: Privileged, Baseline, Restricted
  |   +-- Namespace labels for enforcement
  |   +-- Compliant securityContext
  |
  +-- PHASE 3: SUPPLY CHAIN & RUNTIME ------
  |
  L06: Image Scanning & Supply Chain (25 min) - Layer 1
  |   +-- Trivy scanning with severity levels
  |   +-- CI/CD integration (fail on HIGH+)
  |   +-- SBOM generation, Cosign overview
  |
  L07: Dapr Security (25 min) - Layer 2 (AI Collaboration)
  |   +-- mTLS between sidecars (Sentry CA)
  |   +-- API token authentication
  |   +-- Component scopes for isolation
  |   +-- Three Roles: AI as Teacher/Student/Co-Worker
  |
  +-- PHASE 4: GOVERNANCE & INTEGRATION ----
  |
  L08: Compliance Fundamentals (20 min) - Layer 1
  |   +-- SOC2 awareness (access control, audit logging)
  |   +-- HIPAA awareness (encryption, access)
  |   +-- K8s controls supporting compliance
  |
  L09: Capstone - Secure Task API (40 min) - Layer 4
      +-- Apply ALL patterns to Task API
      +-- 10-point security checklist audit
      +-- Penetration test scenarios
      +-- Spec-driven orchestration
```

---

## IV. Lesson Sequence

### L00: Build Your Cloud Security Skill (Layer 3: Intelligence Design)

**Learning Objective**: Create a working `cloud-security` skill using natural conversation with Claude, grounded in official Kubernetes security documentation

**Stage**: 3 (Intelligence Design) — Skill-First pattern: build skill BEFORE learning content

**CEFR Proficiency**: B1

**New Concepts** (count: 1):
1. Skill creation from official documentation

**Cognitive Load Validation**: 1 concept < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-001 (skill creation in 15 min)

**Content Elements**:
- Clone skills-lab fresh (no state assumptions)
- Write LEARNING-SPEC.md (what/why/success criteria)
- Use `/fetching-library-docs kubernetes security` for official docs
- Use `/skill-creator` to build skill from docs (NOT from memory)
- Verify skill works with simple prompt

**Prompt Template**:
```
Using your skill creator skill create a new skill for Kubernetes security.
I will use it to secure Python/FastAPI applications from dev to production.
Cover RBAC, NetworkPolicies, Pod Security Standards, secrets management,
image scanning with Trivy, and Dapr security. Use context7 skill to study
official Kubernetes security documentation first.
```

**"Try With AI" Section**:
1. **Prompt 1**: "Using my cloud-security skill, show me how to create a dedicated ServiceAccount for my Task API with minimal permissions"
   - **What you're learning**: How your skill generates RBAC patterns following least privilege
2. **Prompt 2**: "What's missing from this skill for production workloads?"
   - **What you're learning**: Gap identification — skill improvement through testing

**Estimated Time**: 15 minutes

---

### L01: Cloud Native Security Model (Layer 1: Manual Foundation)

**Learning Objective**: Explain the 4C security model (Cloud, Cluster, Container, Code) and articulate why outer layers must be secure for inner layer security to matter

**Stage**: 1 (Manual Foundation) — Mental model before implementation

**CEFR Proficiency**: B1

**New Concepts** (count: 5):
1. 4C Security Model
2. Cloud layer controls (IAM, network isolation)
3. Cluster layer controls (RBAC, NetworkPolicy, audit)
4. Container layer controls (image scanning, non-root)
5. Code layer controls (input validation, secrets handling)

**Cognitive Load Validation**: 5 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-002 (classify 5+ controls by layer)

**Content Elements**:
- Visual diagram: 4C layers as concentric circles
- Task API examples at each layer:
  - Cloud: Docker Desktop (no cloud IAM, simplified)
  - Cluster: RBAC, NetworkPolicy protect Task API namespace
  - Container: Trivy scans Task API image
  - Code: Task API validates input, handles errors
- **Key principle**: "You cannot compensate for weak outer layers by hardening inner layers"
- Interactive exercise: Classify 10 security controls by layer

**Skill Reflection Section**:
- **Test**: Ask skill "Which 4C layer does RBAC belong to?"
- **Identify gaps**: Does skill explain layer relationships?
- **Improve**: Add layer classification logic if missing

**Key Visuals**:
- 4C concentric circles diagram (from expertise skill)
- Table mapping controls to layers

**Estimated Time**: 25 minutes

---

### L02: RBAC Deep Dive (Layer 1: Manual Foundation)

**Learning Objective**: Implement RBAC for Task API using ServiceAccounts, Roles, and RoleBindings following the principle of least privilege

**Stage**: 1 (Manual Foundation) — Hands-on RBAC implementation

**CEFR Proficiency**: B1

**New Concepts** (count: 6):
1. ServiceAccount (pod identity)
2. Role vs ClusterRole (namespace vs cluster scope)
3. RoleBinding vs ClusterRoleBinding
4. `automountServiceAccountToken: false` pattern
5. `kubectl auth can-i` testing
6. Default ServiceAccount danger

**Cognitive Load Validation**: 6 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-003 (Task API with dedicated ServiceAccount, ConfigMap read only)

**Content Elements**:

**Step 1: Create Dedicated ServiceAccount**
```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: task-api-sa
  namespace: task-api
automountServiceAccountToken: false
```

**Step 2: Create Minimal Role**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: task-api-role
  namespace: task-api
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list"]
```

**Step 3: Bind Role to ServiceAccount**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: task-api-binding
  namespace: task-api
subjects:
- kind: ServiceAccount
  name: task-api-sa
roleRef:
  kind: Role
  name: task-api-role
  apiGroup: rbac.authorization.k8s.io
```

**Step 4: Test Permissions**
```bash
kubectl auth can-i get configmaps --as=system:serviceaccount:task-api:task-api-sa -n task-api
# yes

kubectl auth can-i get secrets --as=system:serviceaccount:task-api:task-api-sa -n task-api
# no - GOOD! Least privilege working
```

**RBAC Decision Matrix** (from expertise skill):
| Scenario | Use | Why |
|----------|-----|-----|
| App needs read Secrets in its namespace | Role + RoleBinding | Namespace-scoped, least privilege |
| CI/CD needs create Deployments across namespaces | ClusterRole + RoleBinding per namespace | Avoid ClusterRoleBinding |

**Skill Reflection Section**:
- **Test**: "Generate RBAC for my Task API that only reads ConfigMaps"
- **Identify gaps**: Does skill use wildcards? (NEVER do this)
- **Improve**: Add decision matrix for Role vs ClusterRole

**Estimated Time**: 30 minutes

---

### L03: NetworkPolicies (Layer 1: Manual Foundation)

**Learning Objective**: Implement default-deny NetworkPolicies and add explicit allow rules for DNS, ingress from Envoy Gateway, and database egress

**Stage**: 1 (Manual Foundation) — Network isolation by code

**CEFR Proficiency**: B1

**New Concepts** (count: 6):
1. Default deny pattern (CRITICAL first step)
2. Ingress rules (from pods/namespaces)
3. Egress rules (to pods/namespaces/ports)
4. podSelector and namespaceSelector
5. CNI requirement (Calico installation)
6. DNS egress exception (essential after default deny)

**Cognitive Load Validation**: 6 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-004 (unauthorized traffic blocked, verifiable with test pod)

**Content Elements**:

**Step 0: Install Calico (Docker Desktop requirement)**
```bash
# Docker Desktop doesn't enforce NetworkPolicy by default
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
kubectl wait --for=condition=ready pod -l k8s-app=calico-node -n kube-system --timeout=300s
```

**Step 1: Default Deny (ALWAYS FIRST)**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: task-api
spec:
  podSelector: {}  # Applies to ALL pods in namespace
  policyTypes:
  - Ingress
  - Egress
```

**Step 2: Allow DNS (Required after default deny!)**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: task-api
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
```

**Step 3: Allow Ingress from Envoy Gateway**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-gateway-ingress
  namespace: task-api
spec:
  podSelector:
    matchLabels:
      app: task-api
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          app: envoy-gateway
    ports:
    - port: 8000
```

**Edge Case: What happens without DNS allow rule?**
```bash
# Test from pod without DNS egress
kubectl exec -it test-pod -n task-api -- nslookup kubernetes.default
# server can't find kubernetes.default: SERVFAIL
# Pods cannot resolve ANY service names!
```

**Verification Exercise**:
```bash
# Create test pod
kubectl run test-pod --image=busybox -n task-api --restart=Never -- sleep 3600

# Try to reach Task API from unauthorized pod
kubectl exec -it test-pod -n default -- wget -O- http://task-api.task-api:8000/health --timeout=5
# Connection timed out - GOOD! NetworkPolicy working

# Cleanup
kubectl delete pod test-pod -n default
```

**Skill Reflection Section**:
- **Test**: "Generate NetworkPolicies for Task API with default deny"
- **Identify gaps**: Does skill remember DNS egress exception?
- **Improve**: Add DNS allow rule as default after deny

**Estimated Time**: 30 minutes

---

### L04: Secrets Management (Layer 1: Manual Foundation)

**Learning Objective**: Create and consume Kubernetes Secrets securely using volume mounts, understanding the secrets hierarchy (K8s Secrets -> Sealed Secrets -> ESO)

**Stage**: 1 (Manual Foundation) — Secrets handling

**CEFR Proficiency**: B1

**New Concepts** (count: 5):
1. K8s Secret creation (base64 encoding)
2. Volume mount consumption (not env vars in manifest)
3. Sealed Secrets overview (GitOps-safe encryption)
4. External Secrets Operator (production pattern)
5. Secret access via RBAC

**Cognitive Load Validation**: 5 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-007 partial (secrets in checklist)

**Content Elements**:

**Step 1: Create Secret**
```bash
kubectl create secret generic db-credentials \
  --from-literal=username=taskapi \
  --from-literal=password=supersecret123 \
  -n task-api
```

**Step 2: Consume via Volume Mount (Preferred)**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: task-api
  namespace: task-api
spec:
  template:
    spec:
      containers:
      - name: task-api
        volumeMounts:
        - name: db-credentials
          mountPath: /secrets/db
          readOnly: true
      volumes:
      - name: db-credentials
        secret:
          secretName: db-credentials
```

**Why Volume Mount over Environment Variables?**
| Method | Risk | Recommendation |
|--------|------|----------------|
| Env vars in manifest | Visible in pod spec, logs, process list | Avoid for secrets |
| Volume mount | Files only accessible in container | Use this |
| External Secrets Operator | Auto-sync from Vault/AWS SM | Production best |

**Secrets Hierarchy Diagram**:
```
Production Maturity →
├── K8s Secrets (base) — OK for dev, stored in etcd
├── Sealed Secrets — Encrypted, safe for GitOps
└── External Secrets Operator — Sync from external vault
```

**External Secrets Overview** (show, don't require):
```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
  namespace: task-api
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: vault-backend
  target:
    name: db-credentials
  data:
  - secretKey: username
    remoteRef:
      key: task-api/db
      property: username
```

**Skill Reflection Section**:
- **Test**: "How should I consume database credentials in Task API?"
- **Identify gaps**: Does skill recommend volume mounts?
- **Improve**: Add consumption best practices

**Estimated Time**: 25 minutes

---

### L05: Pod Security Standards (Layer 1: Manual Foundation)

**Learning Objective**: Apply PSS labels to namespaces and write pod specs that comply with the Restricted profile

**Stage**: 1 (Manual Foundation) — Container hardening via PSS

**CEFR Proficiency**: B1

**New Concepts** (count: 5):
1. PSS levels (Privileged, Baseline, Restricted)
2. Pod Security Admission controller
3. Namespace labels (enforce, warn, audit)
4. securityContext for compliance
5. Common violations and fixes

**Cognitive Load Validation**: 5 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-005 (Task API passes PSS restricted)

**Content Elements**:

**PSS Levels** (from expertise skill):
| Level | Use Case | Key Restrictions |
|-------|----------|------------------|
| **Privileged** | System components (CNI, storage) | None - full access |
| **Baseline** | Development, non-sensitive | Blocks hostNetwork, privileged, hostPath |
| **Restricted** | Production workloads | + runAsNonRoot, drop ALL capabilities, seccompProfile |

**Step 1: Label Namespace**
```bash
kubectl label ns task-api \
  pod-security.kubernetes.io/enforce=restricted \
  pod-security.kubernetes.io/warn=restricted \
  pod-security.kubernetes.io/audit=restricted
```

**Step 2: PSS-Compliant Pod Spec**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: task-api
  namespace: task-api
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: task-api
        image: ghcr.io/org/task-api:v1.0.0
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: ["ALL"]
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}  # Writable tmp for read-only rootfs
```

**Common Violations and Fixes**:
| Violation | Fix |
|-----------|-----|
| `runAsNonRoot` not set | Add `securityContext.runAsNonRoot: true` |
| Privilege escalation allowed | Add `allowPrivilegeEscalation: false` |
| Missing seccomp profile | Add `seccompProfile.type: RuntimeDefault` |
| Capabilities not dropped | Add `capabilities.drop: ["ALL"]` |
| Need writable `/tmp` | Use `emptyDir` volume |

**Verification Exercise**:
```bash
# Test rejection of privileged pod
kubectl run bad-pod --image=busybox --privileged -n task-api
# Error: admission webhook denied the request: violates PodSecurity "restricted"
```

**Skill Reflection Section**:
- **Test**: "Generate a PSS-compliant deployment for Task API"
- **Identify gaps**: Does skill handle read-only rootfs + tmp?
- **Improve**: Add emptyDir pattern for tmp

**Estimated Time**: 25 minutes

---

### L06: Image Scanning & Supply Chain (Layer 1: Manual Foundation)

**Learning Objective**: Scan container images with Trivy, fail CI/CD on HIGH+ vulnerabilities, and generate SBOMs for supply chain transparency

**Stage**: 1 (Manual Foundation) — Supply chain security

**CEFR Proficiency**: B1

**New Concepts** (count: 5):
1. Trivy scanner and severity levels
2. CI/CD integration with exit codes
3. SBOM generation (SPDX format)
4. Image signing with Cosign (overview)
5. Digest pinning vs tag

**Cognitive Load Validation**: 5 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-006 (no CRITICAL vulnerabilities)

**Content Elements**:

**Step 1: Install Trivy**
```bash
# macOS
brew install trivy

# Linux
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
```

**Step 2: Scan Task API Image**
```bash
# Basic scan
trivy image task-api:latest

# Fail on HIGH or CRITICAL
trivy image task-api:latest --exit-code 1 --severity HIGH,CRITICAL

# Output as JSON for CI/CD
trivy image task-api:latest --format json -o trivy-report.json
```

**Severity Levels**:
| Severity | Action | Example |
|----------|--------|---------|
| CRITICAL | Block deployment | Remote code execution |
| HIGH | Block in prod | Authentication bypass |
| MEDIUM | Review and plan | Information disclosure |
| LOW | Track | Minor issues |
| UNKNOWN | Monitor | Unscored CVEs |

**Step 3: CI/CD Integration Pattern**
```yaml
# GitHub Actions example
- name: Scan image
  run: |
    trivy image ${{ env.IMAGE_NAME }} \
      --exit-code 1 \
      --severity HIGH,CRITICAL \
      --format sarif \
      -o trivy-results.sarif

- name: Upload results
  uses: github/codeql-action/upload-sarif@v2
  with:
    sarif_file: trivy-results.sarif
```

**Step 4: Generate SBOM**
```bash
trivy image task-api:latest --format spdx-json -o sbom.json
```

**Cosign Signing Overview** (show, don't require on Docker Desktop):
```bash
# Sign image (keyless with OIDC)
cosign sign ghcr.io/org/task-api:v1.0.0

# Verify before deploy
cosign verify ghcr.io/org/task-api:v1.0.0
```

**Image Digest Pinning**:
```yaml
# BAD: Tag can be overwritten
image: ghcr.io/org/task-api:v1.0.0

# GOOD: Digest is immutable
image: ghcr.io/org/task-api:v1.0.0@sha256:abc123...
```

**Skill Reflection Section**:
- **Test**: "Show me how to scan Task API image and fail on vulnerabilities"
- **Identify gaps**: Does skill include SBOM generation?
- **Improve**: Add SBOM and CI/CD exit code patterns

**Estimated Time**: 25 minutes

---

### L07: Dapr Security (Layer 2: AI Collaboration)

**Learning Objective**: Configure Dapr security including mTLS verification, API token authentication, and component scopes using AI collaboration with Three Roles

**Stage**: 2 (AI Collaboration with Three Roles) — Dapr is complex; AI helps navigate

**CEFR Proficiency**: B1

**New Concepts** (count: 5):
1. mTLS between Dapr sidecars
2. Sentry CA verification
3. API token authentication
4. Component scopes for isolation
5. Secret scopes

**Cognitive Load Validation**: 5 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-007 partial (Dapr in checklist)

**Content Elements**:

**Three Roles Demonstrations** (REQUIRED for Layer 2):

**Role 1: AI as Teacher**
- **Scenario**: Student asks "How do I verify mTLS is working between Dapr sidecars?"
- **AI suggests**:
  ```
  I recommend checking Sentry CA health. Here's why:
  - Dapr Sentry issues certificates to sidecars
  - mTLS is enabled by default in Kubernetes mode
  - Verify with: dapr mtls status

  Commands to verify:
  kubectl get pods -n dapr-system
  dapr mtls expiry
  ```
- **What student learns**: Sentry CA role and verification commands (new knowledge)

**Role 2: AI as Student**
- **Scenario**: AI suggests comprehensive API token auth for all endpoints
- **Student responds**: "That's too restrictive for dev. Only secure external APIs."
- **AI adapts**:
  ```
  Understood. For development, enable API tokens only for:
  - Dapr HTTP API exposed externally
  - Service invocation from untrusted namespaces

  Internal sidecar-to-sidecar already has mTLS.

  Updated configuration:
  [Shows scoped token auth]
  ```
- **What AI learns**: Student's dev vs prod security requirements

**Role 3: AI as Co-Worker**
- **Scenario**: Configuring component scopes for Task API
- **Iteration 1**: AI generates scope for state store only
- **Student feedback**: "Also need to scope the pub/sub component"
- **Iteration 2**: AI adds pub/sub scope
- **Convergence**: Together they produced comprehensive component isolation

**Step 1: Verify mTLS Status**
```bash
# Check Sentry is running
kubectl get pods -n dapr-system -l app=dapr-sentry

# Check mTLS is enabled
dapr mtls status

# Check certificate expiry
dapr mtls expiry
```

**Step 2: Component Scopes**
```yaml
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: statestore
  namespace: dapr-system
spec:
  type: state.redis
  version: v1
  metadata:
  - name: redisHost
    value: redis:6379
  scopes:
  - task-api  # ONLY task-api can use this component
```

**Step 3: API Token Authentication** (optional for production)
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: dapr-api-token
  namespace: dapr-system
type: Opaque
data:
  token: <base64-encoded-token>
```

**Verification**:
```bash
# Test component scope enforcement
kubectl exec -it another-app -- curl http://localhost:3500/v1.0/state/statestore
# 403 Forbidden - component not scoped to this app
```

**Skill Reflection Section**:
- **Test**: "Help me configure Dapr security for Task API"
- **Identify gaps**: Does skill explain mTLS verification?
- **Improve**: Add Sentry CA commands and scope patterns

**Estimated Time**: 25 minutes

---

### L08: Compliance Fundamentals (Layer 1: Manual Foundation)

**Learning Objective**: Identify Kubernetes controls that support SOC2 and HIPAA requirements, understanding this is awareness (not certification preparation)

**Stage**: 1 (Manual Foundation) — Compliance awareness

**CEFR Proficiency**: B1

**New Concepts** (count: 4):
1. SOC2 technical controls (access, audit, data protection)
2. HIPAA technical controls (encryption, access, audit)
3. Kubernetes controls mapping
4. Evidence collection for audits

**Cognitive Load Validation**: 4 concepts < 10 (B1 limit) = WITHIN LIMIT

**Maps to Evals**: SC-008 (articulate 3 K8s controls for SOC2)

**Content Elements**:

**Important Disclaimer**:
> This lesson provides **technical awareness** of how Kubernetes controls support compliance frameworks. Full compliance requires organizational policies, procedures, and professional audit. This is NOT a certification preparation guide.

**SOC2 Relevant Kubernetes Controls**:
| SOC2 Requirement | Kubernetes Control | Evidence |
|------------------|-------------------|----------|
| Access Control | RBAC, ServiceAccounts | `kubectl get rolebindings` |
| Change Management | GitOps, signed commits | ArgoCD history, Git log |
| Audit Logging | Kubernetes audit policy | `/var/log/kubernetes/audit.log` |
| Data Protection | Secrets encryption at rest | etcd encryption config |

**HIPAA Relevant Kubernetes Controls**:
| HIPAA Requirement | Kubernetes Control | Evidence |
|-------------------|-------------------|----------|
| Access Control | RBAC + NetworkPolicy | Role definitions, policies |
| Audit Trail | Audit logging, app logs | Centralized logging (Loki) |
| Encryption in Transit | mTLS (Dapr, Istio) | Certificate verification |
| Encryption at Rest | etcd encryption, volume encryption | Encryption config |

**Enabling Kubernetes Audit Logging**:
```yaml
# /etc/kubernetes/audit-policy.yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
  resources:
  - group: ""
    resources: ["secrets", "configmaps"]
- level: RequestResponse
  resources:
  - group: ""
    resources: ["pods"]
```

**Evidence Collection Checklist** (for audits):
- [ ] RBAC configuration exports
- [ ] NetworkPolicy definitions
- [ ] Audit log samples
- [ ] Image scanning reports
- [ ] Certificate rotation logs
- [ ] GitOps commit history

**Three Controls for SOC2 Access Control** (eval answer):
1. RBAC with least privilege (who can access what)
2. ServiceAccount isolation (pod identity)
3. Kubernetes audit logging (who did what when)

**Skill Reflection Section**:
- **Test**: "What Kubernetes controls support SOC2 access control?"
- **Identify gaps**: Does skill map controls to frameworks?
- **Improve**: Add compliance mapping table

**Estimated Time**: 20 minutes

---

### L09: Capstone - Secure Task API (Layer 4: Spec-Driven Integration)

**Learning Objective**: Apply all security patterns to Task API using specification-first approach, complete a 10-point security audit checklist, and document security posture

**Stage**: 4 (Spec-Driven Integration) — Compose all patterns

**CEFR Proficiency**: B1

**Maps to Evals**: SC-007 (10-point checklist), ALL evals integrated

**Content Elements**:

**Step 1: Write Security Specification (FIRST)**
```markdown
# Task API Security Specification

## Intent
Deploy Task API to Kubernetes with production-grade security controls.

## Constraints
- Must pass PSS restricted profile
- Must have default-deny NetworkPolicy
- Must use dedicated ServiceAccount with minimal RBAC
- Must pass Trivy scan with no CRITICAL vulnerabilities
- Database credentials via K8s Secrets (volume mount)
- Dapr component scoped to task-api only

## Success Criteria
- All 10-point security checklist passes
- Penetration test scenarios blocked
```

**Step 2: Compose Security Components**

Using skill and lessons 01-08:
1. Namespace with PSS labels (L05)
2. ServiceAccount + RBAC (L02)
3. Default-deny NetworkPolicy + allows (L03)
4. K8s Secret for database credentials (L04)
5. PSS-compliant Deployment (L05)
6. Trivy-scanned image (L06)
7. Dapr component scopes (L07)

**Step 3: 10-Point Security Audit Checklist**

| # | Check | Command | Expected |
|---|-------|---------|----------|
| 1 | Dedicated ServiceAccount | `kubectl get deployment task-api -o jsonpath='{.spec.template.spec.serviceAccountName}'` | `task-api-sa` |
| 2 | Token not mounted | `kubectl get sa task-api-sa -o jsonpath='{.automountServiceAccountToken}'` | `false` |
| 3 | Minimal RBAC | `kubectl auth can-i '*' '*' --as=system:serviceaccount:task-api:task-api-sa` | `no` |
| 4 | Default deny exists | `kubectl get netpol default-deny -n task-api` | exists |
| 5 | PSS restricted | `kubectl get ns task-api -o jsonpath='{.metadata.labels.pod-security\.kubernetes\.io/enforce}'` | `restricted` |
| 6 | runAsNonRoot | `kubectl get pod -l app=task-api -n task-api -o jsonpath='{.items[0].spec.securityContext.runAsNonRoot}'` | `true` |
| 7 | No CRITICAL vulns | `trivy image task-api:latest --severity CRITICAL --exit-code 1` | exit 0 |
| 8 | Secrets via volume | Check Deployment volumeMounts | `/secrets/` path |
| 9 | Dapr scope set | Check Component scopes | `task-api` only |
| 10 | Image digest pinned | Check Deployment image | `@sha256:...` |

**Step 4: Penetration Test Scenarios**

```bash
# Scenario 1: Unauthorized namespace access
kubectl exec -it attacker-pod -n default -- curl http://task-api.task-api:8000/health
# Expected: Connection timeout (NetworkPolicy blocks)

# Scenario 2: Privilege escalation attempt
kubectl run bad-pod --image=busybox --privileged -n task-api
# Expected: Admission denied (PSS restricted)

# Scenario 3: Access secrets from other namespace
kubectl exec -it attacker-pod -n default -- cat /var/run/secrets/kubernetes.io/serviceaccount/token
# Even if token exists, can't access task-api secrets (RBAC)
```

**Step 5: Document Security Posture**
```markdown
# Task API Security Posture

## 4C Layer Coverage
- Cloud: Docker Desktop (N/A for cloud IAM)
- Cluster: RBAC (least privilege), NetworkPolicy (default deny), PSS (restricted)
- Container: Trivy (0 CRITICAL), non-root, read-only rootfs
- Code: Input validation (FastAPI), error handling

## Controls Applied
[List all 10 checklist items with status]

## Known Limitations
- Docker Desktop: No cloud IAM integration
- Cosign verification: Not enforced (requires policy controller)

## Evidence Location
- RBAC definitions: `k8s/rbac/`
- NetworkPolicies: `k8s/network/`
- Trivy reports: `reports/trivy/`
```

**Estimated Time**: 40 minutes

---

## V. Skill Dependencies

**Skill Dependency Graph**:
```
[4C Mental Model] (no prerequisites) --> L01
[4C Mental Model] --> [RBAC] --> L02
[RBAC] --> [NetworkPolicy] --> L03
[NetworkPolicy] --> [Secrets] --> L04
[Secrets, RBAC] --> [PSS] --> L05
[PSS, Container basics] --> [Image Scanning] --> L06
[All cluster security] --> [Dapr Security] --> L07
[All security patterns] --> [Compliance Mapping] --> L08
[ALL] --> [Capstone Integration] --> L09
```

**Cross-Chapter Dependencies**:
| Prerequisite | From | Required For |
|--------------|------|--------------|
| Kubernetes fundamentals | Ch50 | All lessons |
| Pods, Deployments, Services | Ch50 L03-L05 | L02-L09 |
| Namespaces | Ch50 L06 | L02 (RBAC scoping) |
| Dapr basics | Ch53 | L07 (Dapr security) |
| Docker images | Ch49 | L06 (image scanning) |
| Task API | Ch40 | Running example |

**Validation**: All prerequisite chapters implemented (Ch49, Ch50, Ch53)

---

## VI. Assessment Plan

### Formative Assessments (During Lessons)

| Lesson | Assessment | Bloom's Level |
|--------|------------|---------------|
| L01 | Classify 10 controls by 4C layer | Understand |
| L02 | Implement RBAC, test with can-i | Apply |
| L03 | Block traffic with NetworkPolicy | Apply |
| L04 | Mount secrets correctly | Apply |
| L05 | Pass PSS restricted | Apply |
| L06 | Scan image, fail on CRITICAL | Apply |
| L07 | Configure Dapr scopes | Apply |
| L08 | List 3 SOC2 controls | Remember |

### Summative Assessment (End of Chapter)

**L09 Capstone**:
- 10-point security checklist audit (Apply)
- Penetration test scenario blocking (Analyze)
- Security posture documentation (Create)

**All assessments align with CEFR B1 and Bloom's Apply/Analyze levels**

---

## VII. Images and Visuals

### Required Images

| Lesson | Visual | Description | Source |
|--------|--------|-------------|--------|
| L01 | 4C-layers-diagram.png | Concentric circles showing Cloud > Cluster > Container > Code | Create from expertise skill ASCII |
| L01 | defense-in-depth-flow.png | Attack blocked at multiple layers | New |
| L02 | rbac-relationships.png | ServiceAccount -> RoleBinding -> Role -> Resources | New |
| L03 | networkpolicy-flow.png | Default deny + allow rules visualization | New |
| L05 | pss-levels-comparison.png | Privileged vs Baseline vs Restricted | New |
| L06 | supply-chain-workflow.png | Build -> Scan -> Sign -> Deploy | New |
| L09 | security-checklist-status.png | 10-point checklist with pass/fail | Screenshot |

### Video Recommendations

| Lesson | Video Topic | Duration |
|--------|-------------|----------|
| L03 | NetworkPolicy debugging (traffic blocked) | 2-3 min demo |
| L06 | Trivy scanning workflow | 2 min demo |

---

## VIII. Content Dependencies and Ordering

### Internal Dependencies (Within Chapter)

```
L00 (Skill) --> Independent (start here)
L01 (4C Model) --> Requires L00 skill for reflection
L02 (RBAC) --> Requires L01 (understand cluster layer)
L03 (NetworkPolicy) --> Requires L01 (understand cluster layer)
L04 (Secrets) --> Requires L02 (RBAC protects secrets)
L05 (PSS) --> Requires L02, L04 (ServiceAccount, Secrets context)
L06 (Image Scan) --> Requires L05 (container layer context)
L07 (Dapr) --> Requires L02-L06 (cluster security foundation)
L08 (Compliance) --> Requires L02-L07 (all controls for mapping)
L09 (Capstone) --> Requires ALL previous lessons
```

### External Dependencies

- **Docker Desktop with Kubernetes enabled** (Ch50 L02)
- **Task API container image built** (Ch49)
- **Dapr installed in cluster** (Ch53)
- **Calico CNI for NetworkPolicy** (installed in L03)

---

## IX. Validation Checklist

**Chapter-Level Validation**:
- [x] Chapter type identified: Technical/Code-Focused
- [x] Concept density analysis: 12 concepts (Complex)
- [x] Lesson count justified: 10 lessons (L00-L09)
- [x] All evals from spec covered by lessons (SC-001 through SC-008)
- [x] All lessons map to at least one eval

**Stage Progression Validation**:
- [x] L00: Layer 3 (Skill-First pattern)
- [x] L01-L06, L08: Layer 1 (Manual foundation)
- [x] L07: Layer 2 (AI Collaboration with Three Roles)
- [x] L09: Layer 4 (Spec-Driven Integration)
- [x] Spec-first only in L09 (capstone)

**Cognitive Load Validation**:
- [x] Each lesson's concept count <= 10 (B1 limit)
- [x] L01: 5 concepts, L02: 6, L03: 6, L04: 5, L05: 5, L06: 5, L07: 5, L08: 4

**Dependency Validation**:
- [x] Skill dependencies satisfied by lesson order
- [x] Cross-chapter dependencies validated (Ch49, Ch50, Ch53 implemented)

**Three Roles Validation** (L07):
- [x] AI as Teacher: mTLS verification commands (new knowledge)
- [x] AI as Student: Adapts to dev vs prod requirements
- [x] AI as Co-Worker: Converges on comprehensive component scopes

**Expertise Skill Integration**:
- [x] 4C model diagram used (L01)
- [x] RBAC decision matrix used (L02)
- [x] NetworkPolicy patterns used (L03)
- [x] PSS level table used (L05)
- [x] Trivy commands used (L06)
- [x] Dapr security patterns used (L07)
- [x] Compliance mapping used (L08)
- [x] Safety guardrails applied (NEVER/ALWAYS lists)

---

## X. Total Duration

| Lesson | Duration |
|--------|----------|
| L00 | 15 min |
| L01 | 25 min |
| L02 | 30 min |
| L03 | 30 min |
| L04 | 25 min |
| L05 | 25 min |
| L06 | 25 min |
| L07 | 25 min |
| L08 | 20 min |
| L09 | 40 min |
| **Total** | **260 min (~4.3 hours)** |

---

## XI. File Naming Convention

Following `specs/book/directory-structure.md`:

```
apps/learn-app/docs/07-AI-Cloud-Native-Development/58-production-security/
├── README.md                           # Chapter overview (matches Ch49/Ch50 structure)
├── 00-build-your-cloud-security-skill.md  # L00
├── 01-cloud-native-security-model.md      # L01
├── 02-rbac-deep-dive.md                   # L02
├── 03-network-policies.md                 # L03
├── 04-secrets-management.md               # L04
├── 05-pod-security-standards.md           # L05
├── 06-image-scanning-supply-chain.md      # L06
├── 07-dapr-security.md                    # L07
├── 08-compliance-fundamentals.md          # L08
└── 09-capstone-secure-task-api.md         # L09
```

---

**Plan Status**: Ready for implementation
**Next Step**: Execute with content-implementer subagent per lesson
