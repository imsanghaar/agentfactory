name: Sync to SSO Mirror

on:
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to SSO mirror with deploy trigger
        env:
          SSO_PAT: ${{ secrets.SSO_PAT }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          SOURCE_SHA: ${{ github.sha }}
        run: |
          # Fail early if secret is not provided
          if [ -z "${SSO_PAT}" ]; then
            echo "Error: SSO_PAT secret is not set. Add it under repository secrets with a PAT that has write access to the target repo." >&2
            exit 1
          fi

          # Configure git credentials for authentication
          git config user.name "imsanghaar"
          git config user.email "imsanghaar@users.noreply.github.com"

          # Use x-access-token as the username when embedding a personal access token in an https URL
          MIRROR_URL="https://x-access-token:${SSO_PAT}@github.com/imsanghaar/sso-mirror-mono.git"

          # Force push source to mirror
          git push "${MIRROR_URL}" HEAD:main --force

          # Update CHANGELOG with sync timestamp to trigger Vercel deployment
          echo "Synced from imsanghaar/agentfactory at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > CHANGELOG.md
          echo "Source commit: ${SOURCE_SHA}" >> CHANGELOG.md
          echo "Message: ${COMMIT_MESSAGE}" >> CHANGELOG.md

          git add CHANGELOG.md
          # Only commit/push if there are changes to avoid failing when nothing changed
          if git diff --cached --quiet; then
            echo "No CHANGELOG changes to commit"
          else
            git commit -m "sync: trigger deploy from ${SOURCE_SHA}"
            git push "${MIRROR_URL}" HEAD:main
          fi
